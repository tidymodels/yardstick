<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Grouping behavior in yardstick • yardstick</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Grouping behavior in yardstick">
<meta name="robots" content="noindex">
<script defer data-domain="yardstick.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">yardstick</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/grouping.html">Grouping behavior in yardstick</a></li>
    <li><a class="dropdown-item" href="../articles/metric-types.html">Metric types</a></li>
    <li><a class="dropdown-item" href="../articles/multiclass.html">Multiclass averaging</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-more" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn more</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-more">
<li><a class="external-link dropdown-item" href="https://www.tidymodels.org/learn/develop/metrics/">Custom performance metrics</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidymodels/yardstick/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Grouping behavior in yardstick</h1>
                        <h4 data-toc-skip class="author">Simon
Couch</h4>
            
            <h4 data-toc-skip class="date">2025-01-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/yardstick/blob/main/vignettes/grouping.Rmd" class="external-link"><code>vignettes/grouping.Rmd</code></a></small>
      <div class="d-none name"><code>grouping.Rmd</code></div>
    </div>

    
    
<p>The 1.3.0 release of yardstick introduced an implementation for
<em>groupwise metrics</em>. The use case motivating the implementation
of this functionality is <em>fairness metrics</em>, though groupwise
metrics have applications beyond that domain. Fairness metrics quantify
the degree of disparity in a metric value across groups. To learn more
about carrying out fairness-oriented analyses with tidymodels, see the
blog post on the tidymodels website. This vignette will instead focus on
groupwise metrics generally, clarifying the meaning of “groupwise” and
demonstrating functionality with an example dataset.</p>
<!-- TODO: link to forthcoming tidymodels blog post -->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick" class="external-link">yardstick</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"hpc_cv"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="group-awareness">Group-awareness<a class="anchor" aria-label="anchor" href="#group-awareness"></a>
</h2>
<p>Even before the implementation of groupwise metrics, <em>all</em>
yardstick metrics had been <em>group-aware</em>. When grouped data is
passed to a group-aware metric, it will return metric values calculated
for each group.</p>
<p>To demonstrate, we’ll make use of the <code>hpc_cv</code> data set,
containing class probabilities and class predictions for a linear
discriminant analysis fit to the HPC data set of Kuhn and Johnson
(2013). The model is evaluated via 10-fold cross-validation, and the
predictions for all folds are included.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">hpc_cv</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,467 × 7</span></span></span>
<span><span class="co">#&gt;    obs   pred     VF      F       M          L Resample</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> VF    VF    0.914 0.077<span style="text-decoration: underline;">9</span> 0.008<span style="text-decoration: underline;">48</span> 0.000<span style="text-decoration: underline;">019</span>9  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> VF    VF    0.938 0.057<span style="text-decoration: underline;">1</span> 0.004<span style="text-decoration: underline;">82</span> 0.000<span style="text-decoration: underline;">010</span>1  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> VF    VF    0.947 0.049<span style="text-decoration: underline;">5</span> 0.003<span style="text-decoration: underline;">16</span> 0.000<span style="text-decoration: underline;">005</span>00 Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> VF    VF    0.929 0.065<span style="text-decoration: underline;">3</span> 0.005<span style="text-decoration: underline;">79</span> 0.000<span style="text-decoration: underline;">015</span>6  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> VF    VF    0.942 0.054<span style="text-decoration: underline;">3</span> 0.003<span style="text-decoration: underline;">81</span> 0.000<span style="text-decoration: underline;">007</span>29 Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> VF    VF    0.951 0.046<span style="text-decoration: underline;">2</span> 0.002<span style="text-decoration: underline;">72</span> 0.000<span style="text-decoration: underline;">003</span>84 Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> VF    VF    0.914 0.078<span style="text-decoration: underline;">2</span> 0.007<span style="text-decoration: underline;">67</span> 0.000<span style="text-decoration: underline;">035</span>4  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> VF    VF    0.918 0.074<span style="text-decoration: underline;">4</span> 0.007<span style="text-decoration: underline;">26</span> 0.000<span style="text-decoration: underline;">015</span>7  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> VF    VF    0.843 0.128  0.029<span style="text-decoration: underline;">6</span>  0.000<span style="text-decoration: underline;">192</span>   Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> VF    VF    0.920 0.072<span style="text-decoration: underline;">8</span> 0.007<span style="text-decoration: underline;">03</span> 0.000<span style="text-decoration: underline;">014</span>7  Fold01  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3,457 more rows</span></span></span></code></pre></div>
<p>For the purposes of this vignette, we’ll also add a column
<code>batch</code> to the data and select off the columns for the class
probabilities, which we don’t need.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hpc</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">hpc_cv</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">VF</span>, <span class="cn">F</span>, <span class="va">M</span>, <span class="va">L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hpc</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,467 × 4</span></span></span>
<span><span class="co">#&gt;    obs   pred  Resample batch</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3,457 more rows</span></span></span></code></pre></div>
<p>If we wanted to compute the accuracy of the first resampled model, we
could write:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy multiclass     0.726</span></span></code></pre></div>
<p>The metric function returns one row, giving the <code>.metric</code>,
<code>.estimator</code>, and <code>.estimate</code> for the whole data
set it is passed.</p>
<p>If we instead group the data by fold, metric functions like
<code>accuracy</code> will know to compute values for each group; in the
output, each row will correspond to a Resample.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Resample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">#&gt;    Resample .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Fold01   accuracy multiclass     0.726</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Fold02   accuracy multiclass     0.712</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Fold03   accuracy multiclass     0.758</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Fold04   accuracy multiclass     0.712</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Fold05   accuracy multiclass     0.712</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Fold06   accuracy multiclass     0.697</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Fold07   accuracy multiclass     0.675</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Fold08   accuracy multiclass     0.721</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Fold09   accuracy multiclass     0.673</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Fold10   accuracy multiclass     0.699</span></span></code></pre></div>
<p>Note that the first row, corresponding to <code>Fold01</code>, gives
the same value as manually filtering for the observations corresponding
to the first resample and then computing the accuracy.</p>
<p>This behavior is what we mean by group-awareness. When grouped data
is passed to group-aware metric functions, they will return values for
each group.</p>
</div>
<div class="section level2">
<h2 id="groupwise-metrics">Groupwise metrics<a class="anchor" aria-label="anchor" href="#groupwise-metrics"></a>
</h2>
<p>Groupwise metrics are associated with a data-column such that, when
passed data with that column, the metric will temporarily group by that
column, compute values for each of the groups defined by the column, and
then aggregate the values computed for the temporary grouping back to
the level of the input data’s grouping.</p>
<p>More concretely, let’s turn to an example where there is no
pre-existing grouping in the data. Consider the portion of the HPC data
pertaining to the first resample:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 347 × 4</span></span></span>
<span><span class="co">#&gt;    obs   pred  Resample batch</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> VF    VF    Fold01   a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> VF    VF    Fold01   b    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 337 more rows</span></span></span></code></pre></div>
<p>Suppose that the <code>batch</code>es in the data represent two
groups for which model performance ought not to differ. To quantify the
degree to which model performance differs for these two groups, we could
compute accuracy values for either group separately, and then take their
difference. First, computing accuracies:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acc_by_group</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acc_by_group</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   batch .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> a     accuracy multiclass     0.713</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> b     accuracy multiclass     0.739</span></span></code></pre></div>
<p>Now, taking the difference:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">acc_by_group</span><span class="op">$</span><span class="va">.estimate</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">acc_by_group</span><span class="op">$</span><span class="va">.estimate</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.02518607</span></span></code></pre></div>
<p>Groupwise metrics encode the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> and aggregation
step (in this case, subtraction) shown above into a yardstick metric. We
can define a new groupwise metric with the
<code><a href="../reference/new_groupwise_metric.html">new_groupwise_metric()</a></code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy_diff</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/new_groupwise_metric.html">new_groupwise_metric</a></span><span class="op">(</span></span>
<span>    fn <span class="op">=</span> <span class="va">accuracy</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"accuracy_diff"</span>,</span>
<span>    aggregate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">acc_by_group</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">acc_by_group</span><span class="op">$</span><span class="va">.estimate</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">acc_by_group</span><span class="op">$</span><span class="va">.estimate</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<ul>
<li>The <code>fn</code> argument is the yardstick metric that will be
computed for each data group.</li>
<li>The <code>name</code> argument gives the name of the new metric
we’ve created; we’ll call ours “accuracy difference.”</li>
<li>The <code>aggregate</code> argument is a function defining how to go
from <code>fn</code> output by group to a single numeric value.</li>
</ul>
<p>The output, <code>accuracy_diff</code>, is a function subclass called
a <code>metric_factory</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">accuracy_diff</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "metric_factory" "function"</span></span></code></pre></div>
<p><code>accuracy_diff</code> now knows to take accuracy values for each
group and then return the difference between the accuracy for the first
and second result as output. The last thing we need to associate with
the object is the name of the grouping variable to pass to
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code>; we can pass that variable name to
<code>accuracy_diff</code> to do so:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy_diff_by_batch</span> <span class="op">&lt;-</span> <span class="fu">accuracy_diff</span><span class="op">(</span><span class="va">batch</span><span class="op">)</span></span></code></pre></div>
<p>The output, <code>accuracy_diff_by_batch</code>, is a yardstick
metric function like any other:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "class_metric" "metric"       "function"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">accuracy_diff_by_batch</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "class_metric" "metric"       "function"</span></span></code></pre></div>
<!-- TODO: once a print method is added, we can print this out and the meaning of "this is just a yardstick metric" will be clearer -->
<p>We can use the <code>accuracy_diff_by_batch()</code> metric in the
same way that we would use <code><a href="../reference/accuracy.html">accuracy()</a></code>. On its own:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">accuracy_diff_by_batch</span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   .metric       .by   .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy_diff batch multiclass   -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">2</span></span></span></code></pre></div>
<p>We can also add <code>accuracy_diff_by_batch()</code> to metric
sets:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acc_ms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">accuracy</span>, <span class="va">accuracy_diff_by_batch</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">acc_ms</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">obs</span>, estimate <span class="op">=</span> <span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   .metric       .estimator .estimate .by  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy      multiclass    0.726  <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> accuracy_diff multiclass   -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">2</span> batch</span></span></code></pre></div>
<p><em>Groupwise metrics are group-aware.</em> When passed data with any
grouping variables other than the column passed as the first argument to
<code>accuracy_diff()</code>—in this case,
<code>group</code>—<code>accuracy_diff_by_batch()</code> will behave
like any other yardstick metric. For example:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hpc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Resample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">accuracy_diff_by_batch</span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;    Resample .metric       .by   .estimator .estimate</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Fold01   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">2</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Fold02   accuracy_diff batch multiclass  0.106   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Fold03   accuracy_diff batch multiclass  0.022<span style="text-decoration: underline;">0</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Fold04   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.000</span><span style="color: #BB0000; text-decoration: underline;">300</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Fold05   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.036</span><span style="color: #BB0000; text-decoration: underline;">1</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Fold06   accuracy_diff batch multiclass  0.015<span style="text-decoration: underline;">3</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Fold07   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.032</span><span style="color: #BB0000; text-decoration: underline;">3</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Fold08   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.015</span><span style="color: #BB0000; text-decoration: underline;">9</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Fold09   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.013</span><span style="color: #BB0000; text-decoration: underline;">1</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Fold10   accuracy_diff batch multiclass -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">5</span></span></span></code></pre></div>
<p>Groupwise metrics form the backend of fairness metrics in tidymodels.
To learn more about groupwise metrics and their applications in fairness
problems, see <code><a href="../reference/new_groupwise_metric.html">new_groupwise_metric()</a></code>.</p>
<!-- TODO: link to tidyverse blog post and tidymodels articles. -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, Emil Hvitfeldt, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
